---
- name: Use proxy
  hosts:
    - all:!proxies
  become: true
  gather_facts: true
  tags:
    - proxy
  roles:
    - use-proxy

- name: Install Common Dependencies
  hosts:
    - all:!ansible-k3s
  become: true
  gather_facts: true
  tags:
    - dependencies
  tasks:
    - name: Udate apt cache
      changed_when: false
      ansible.builtin.apt:
        update_cache: true
      tags:
        - dependencies
    - name: Install common dependencies
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - git
          - jq
          - uidmap
        state: present

- name: Configure SSH keys for Bootstrap user
  hosts:
    - all:!ansible-k3s
  become: true
  gather_facts: true
  tags:
    - ssh
    - users
    - bootstrap
  vars:
    can_sudo: true
    user_name: bootstrap
    user_password: "{{ bootstrap_password }}"
    authorized_keys: |
      {{ ssh.devops.cert }}
      {{ ssh.bootstrap.cert }}
  roles:
    - user

- name: Create Ansible user
  hosts:
    - all:!ansible-k3s
  become: true
  gather_facts: true
  tags:
    - ssh
    - ansible
  vars:
    can_sudo: true
    user_name: ansible
    authorized_keys: "{{ ssh.ansible.cert }}"
    user_password: "{{ ssh.ansible.password }}"
  roles:
    - user

- name: Create Devops user
  hosts:
    - all:!ansible-k3s:!desktops
  become: true
  gather_facts: true
  tags:
    - ssh
    - devops
  vars:
    can_sudo: true
    user_name: devops
    authorized_keys: "{{ ssh.devops.cert }}"
    user_password: "{{ ssh.devops.password }}"
  roles:
    - user

- name: Create Coffee user
  hosts:
    - media
  become: true
  gather_facts: true
  tags:
    - coffee
  vars:
    can_sudo: false
    user_name: coffee
    user_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      34313364663235353734316432353937316537643565363730646661626131643834393037616131
      6430346561636634323438636662646630346232363762630a623334316336376236393934613162
      65343938653565663965383331303364663730653037336161643864653564643832313261303433
      3266356637303730310a313834373234363064643332613830303961393665393934383838323965
      6639
  roles:
    - user

- name: Create Coffee user
  hosts:
    - media
  become: true
  gather_facts: true
  tags:
    - coffee
  vars:
    can_sudo: false
    user_name: coffee
    user_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      34313364663235353734316432353937316537643565363730646661626131643834393037616131
      6430346561636634323438636662646630346232363762630a623334316336376236393934613162
      65343938653565663965383331303364663730653037336161643864653564643832313261303433
      3266356637303730310a313834373234363064643332613830303961393665393934383838323965
      6639
  roles:
    - user

- name: Configure SSH settings
  hosts:
    - all:!ansible-k3s
  become: true
  gather_facts: true
  tags:
    - ssh
    - ssh-cfg
  roles:
    - ssh

- name: Networking configuration
  hosts:
    - all:!ansible-k3s:!media
  become: true
  gather_facts: true
  tags:
    - network
  roles:
    - netcfg
