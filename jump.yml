---
- name: Install Dependencies
  hosts:
    - jump
  become: yes
  gather_facts: yes
  tags:
    - dependencies
  tasks:
    - name: Udate apt cache
      apt:
        update_cache: yes
      tags:
        - dependencies
    - name: Install common dependencies
      apt:
        name: "{{ item }}"
        state: latest
      with_items:
        - apt-transport-https
        - git
        - jq
        - uidmap

- name: Create devops user
  hosts:
    - jump
  become: yes
  gather_facts: yes
  tags:
    - ssh
    - devops
  vars:
    can_sudo: yes
    user_name: devops
    user_password: "{{ devops_password }}"
  roles:
    - user

- name: Setup devops SSH configuration
  hosts:
    - jump
  become: yes
  gather_facts: yes
  tags:
    - ssh
    - devops
  vars:
    user_name: devops
    authorized_keys: "{{ ssh.devops.authoized_keys }}"
    ssh_key: "{{ ssh.devops.key }}"
    ssh_cert: "{{ ssh.devops.cert }}"
    enable_root_login: yes
  roles:
    - ssh

- name: Setup ansible user
  hosts:
    - jump
  become: yes
  gather_facts: yes
  tags:
    - ssh
    - ansible
  vars:
    user_name: ansible
  roles:
    - user

- name: Setup ansible SSH configuration
  hosts:
    - jump
  become: yes
  gather_facts: yes
  tags:
    - ssh
    - ansible
  vars:
    user_name: ansible
    ssh_key: "{{ ssh.ansible.key }}"
    ssh_cert: "{{ ssh.ansible.cert }}"
    enable_root_login: yes
  roles:
    - ssh

#TODO: Require MFA for logins and sudos

- name: Setup GitHub Actions Runner
  hosts:
    - bastion
  become: yes
  gather_facts: yes
  tags:
    - agent
  vars:
    agent_user: ansible
    agent_token: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      31363162373335343336633366663062316566643036353838633131616536343938323464383839
      3866623931626632633133313732353232643239653137640a326231313632646261333337396366
      33633935303238393664616237653965373730326438613365306439646638613638343034393737
      6261373366663435630a616565646530626637656639383233656661393632363963333337663361
      32643366353636326532633139303661373962373233323335306130376131626265
    agent_url: https://github.com/espresso-software
  roles:
    - agent

#TODO: Setup Docker Swarm (tower)
#TODO: Setup GitHub Actions Ansible Runner Docker Swarm Deployment (tower)

- name: Setup ansible SSH configuration
  hosts:
    - jump
  become: yes
  gather_facts: yes
  tags:
    - ssh
  vars:
    enable_root_login: no
  roles:
    - ssh
